# Event System Implementation Summary

## Overview

Implemented a comprehensive Event management system that auto-creates events from bookings and allows manual event creation for admin calendar visibility.

---

## Files Created/Modified

### 1. **Event Model** (`models/Event.model.js`)

✅ Complete event schema with:

- **Event Types**: `booking-linked`, `standalone`, `blocked`
- **Booking Types**: `hotel`, `package`, `property`
- **Status Management**: `active`, `inactive`, `draft`, `cancelled`, `completed`
- **Capacity Tracking**: maxBookings, currentBookings, availableSlots
- **Auto Color Coding**: Different colors for each booking type

**Key Features:**

- Virtual properties for capacity, date filtering
- Static methods for calendar queries
- `createFromBooking()` - Auto-creates event from booking
- `cancelEvent()` - Cancels event and linked booking
- Automatic duration calculation
- Validation for dates and capacity

### 2. **Booking Model Update** (`models/Booking.model.js`)

✅ Added:

```javascript
linkedEvent: {
  type: mongoose.Schema.Types.ObjectId,
  ref: "Event",
}
```

### 3. **Booking Controller Update** (`controllers/booking.controller.js`)

✅ Modified:

- **Import Event model**
- **`createBooking()`**: Auto-creates event after booking creation
- **`cancelBooking()`**: Updates linked event status to cancelled
- **`deleteBooking()`**: Deletes linked event when booking is deleted

### 4. **Event Controller** (`controllers/event.controller.js`)

✅ Complete CRUD operations:

**Create & Management:**

- `createEvent` - Create standalone events
- `updateEvent` - Update event details (prevents editing auto-generated events)
- `deleteEvent` - Delete event and cancel linked bookings
- `cancelEvent` - Cancel event with reason
- `completeEvent` - Mark event as completed

**Queries:**

- `getEvents` - Get all events with filtering, pagination, sorting
- `getEvent` - Get single event with all relations
- `getCalendarEvents` - Get events for specific month/year
- `getEventsByDateRange` - Get events in date range
- `getUpcomingEvents` - Upcoming events only
- `getPastEvents` - Past events only
- `getCurrentEvents` - Currently ongoing events
- `getEventStats` - Event statistics

**Status Management:**

- `updateEventStatus` - Update event status (syncs with booking)

### 5. **Event Routes** (`routes/event.routes.js`)

✅ All routes configured with admin middleware:

```
POST   /api/events                    - Create event
GET    /api/events                    - Get all events (filtered)
GET    /api/events/stats              - Get statistics
GET    /api/events/upcoming           - Get upcoming events
GET    /api/events/past               - Get past events
GET    /api/events/current            - Get current events
GET    /api/events/calendar/:year/:month - Calendar view
GET    /api/events/range              - Date range query
GET    /api/events/:id                - Get single event
PUT    /api/events/:id                - Update event
DELETE /api/events/:id                - Delete event
PATCH  /api/events/:id/status         - Update status
POST   /api/events/:id/complete       - Complete event
POST   /api/events/:id/cancel         - Cancel event
```

### 6. **Server Configuration** (`server.js`)

✅ Updated:

- Imported Event model
- Imported event routes
- Registered `/api/events` endpoint

---

## Data Flow

### Booking → Event (Automatic)

```
1. User creates booking
2. Booking saved to database
3. Event.createFromBooking() called
4. Event auto-created with:
   - title: "Hotel Booking - [Hotel Name]"
   - eventType: "booking-linked"
   - linkedBooking: booking._id
   - autoGenerated: true
   - Same dates as booking
   - Color based on booking type
5. Booking.linkedEvent = event._id
6. Both saved
```

### Manual Event Creation

```
1. Admin opens CreateEventDrawer
2. Fills form (title, dates, location, maxBookings)
3. POST /api/events
4. Event created with:
   - eventType: "standalone"
   - autoGenerated: false
   - Capacity tracking enabled
```

### Event Deletion → Booking Cancellation

```
1. Admin deletes event (DELETE /api/events/:id)
2. If booking-linked: Cancel linked booking
3. If standalone with bookings: Cancel all bookings
4. Event deleted from database
```

---

## Frontend Integration Requirements

### 1. **Event API Service** (`front-end/src/services/eventApi.js`)

Create service with methods:

```javascript
-createEvent(eventData) -
  getEvents(filters) -
  getCalendarEvents(year, month) -
  updateEvent(id, data) -
  deleteEvent(id) -
  cancelEvent(id, reason);
```

### 2. **Update CreateEventDrawer** (`components/CreateEventDrawer.jsx`)

Replace TODO comments with:

```javascript
import { createEvent } from "@/services/eventApi";

const handleSubmit = async (e) => {
  // ... validation ...
  const event = await createEvent(formData);
  // Show success message
};
```

### 3. **EventCalendar Component** (`components/EventCalendar.jsx`)

Implement calendar view:

```javascript
- Fetch events for current month: getCalendarEvents(year, month)
- Display events on calendar
- Color code by eventType/bookingType
- Click event to view details
- Filter by type, status
```

### 4. **Event Filters** (Already created in `EventFilter.jsx`)

Connect to API:

- Search events
- Date range filter (7days, 30days, upcoming, past)
- Status filter
- Event type filter

---

## API Usage Examples

### Create Standalone Event

```javascript
POST /api/events
Headers: { Authorization: "Bearer {token}" }
Body: {
  "title": "Kashmir Valley Tour",
  "description": "7-day guided tour of Kashmir",
  "destination": "Kashmir, India",
  "startDate": "2025-04-15",
  "endDate": "2025-04-22",
  "maxBookings": 50,
  "startLocation": "Delhi Airport",
  "endLocation": "Delhi Airport",
  "status": "active"
}
```

### Get Calendar Events

```javascript
GET /api/events/calendar/2025/3
Headers: { Authorization: "Bearer {token}" }

Response: [
  {
    "_id": "...",
    "title": "Hotel Booking - Mountain Resort",
    "eventType": "booking-linked",
    "bookingType": "hotel",
    "startDate": "2025-03-15",
    "endDate": "2025-03-20",
    "color": "#3B82F6",
    "linkedBooking": { ... }
  },
  {
    "_id": "...",
    "title": "Kashmir Valley Tour",
    "eventType": "standalone",
    "startDate": "2025-03-25",
    "maxBookings": 50,
    "currentBookings": 23,
    "color": "#8B5CF6"
  }
]
```

### Filter Events

```javascript
GET /api/events?dateFilter=upcoming&status=active&search=kashmir
Headers: { Authorization: "Bearer {token}" }
```

### Cancel Event

```javascript
POST /api/events/:id/cancel
Headers: { Authorization: "Bearer {token}" }
Body: {
  "reason": "Weather conditions"
}
// This will also cancel linked booking if applicable
```

---

## Color Coding System

```javascript
🔵 Hotels:     #3B82F6 (Blue)
🟢 Packages:   #10B981 (Green)
🟡 Properties: #F59E0B (Amber)
🟣 Standalone: #8B5CF6 (Purple)
⚫ Blocked:    #6B7280 (Gray)
```

---

## Database Relationships

```
Event
  ├─ linkedBooking → Booking (if booking-linked)
  ├─ bookings: [Booking] (if standalone)
  ├─ user → User
  ├─ hotel → Hotel (if hotel booking)
  ├─ package → Package (if package booking)
  └─ property → Property (if property booking)

Booking
  └─ linkedEvent → Event
```

---

## Testing Checklist

### Backend:

- [ ] Create booking → Event auto-created
- [ ] Cancel booking → Event status updated
- [ ] Delete booking → Event deleted
- [ ] Create standalone event
- [ ] Update standalone event
- [ ] Delete event → Booking cancelled
- [ ] Calendar query returns correct events
- [ ] Date filters work correctly
- [ ] Event statistics accurate

### Frontend:

- [ ] CreateEventDrawer form validation
- [ ] Submit creates event via API
- [ ] Calendar displays all events
- [ ] Color coding works
- [ ] Filters apply correctly
- [ ] Search functionality
- [ ] Delete event confirmation
- [ ] Success/error messages

---

## Next Steps

1. ✅ **Backend Complete** - All models, controllers, routes created
2. ⏳ **Create Event API Service** - Frontend service layer
3. ⏳ **Implement EventCalendar** - Full calendar component
4. ⏳ **Connect CreateEventDrawer** - Wire up API calls
5. ⏳ **Test Integration** - End-to-end testing

---

## Notes

- All event routes require authentication + admin role
- Auto-generated events cannot be manually edited (must edit booking)
- Deleting an event cascades to cancel bookings
- Events sync status with linked bookings
- Calendar queries are optimized with proper indexes
- Color coding is automatic based on event/booking type

---

## Support

For any issues or questions about the event system implementation, refer to:

- Event Model: `back-end/models/Event.model.js`
- Event Controller: `back-end/controllers/event.controller.js`
- API Routes: `back-end/routes/event.routes.js`
